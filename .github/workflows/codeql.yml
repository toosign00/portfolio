name: "CodeQL Advanced with PR Comments"

on:
  push:
    branches: [ "develop", "main" ]
  pull_request:
    branches: [ "develop", "main" ]
  schedule:
    - cron: '0 0 * * 1'  # 매주 월요일 한국시간 09:00

jobs:
  analyze:
    name: Analyze (${{ matrix.language }})
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      packages: read
      actions: read
      contents: read
      pull-requests: write

    strategy:
      fail-fast: false
      matrix:
        include:
        - language: javascript-typescript
          build-mode: none

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ matrix.language }}
        build-mode: ${{ matrix.build-mode }}

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:${{matrix.language}}"
        # 항상 Security 탭에 업로드 (job 통합으로 해결)
        upload: true

    # PR에만 상세 코멘트 추가
    - name: Add comment to PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const comment = `## 🛡️ CodeQL 보안 스캔 결과

          ✅ **보안 스캔이 완료되었습니다.**
          
          📊 **결과 확인**: [Security 탭](https://github.com/${{ github.repository }}/security/code-scanning)에서 상세 내용을 확인하세요.
          
          ### 📋 스캔 정보
          - 🕒 **스캔 시간**: ${new Date().toLocaleString('ko-KR')}
          - 📝 **분석 언어**: JavaScript/TypeScript
          - 🔍 **스캔 범위**: 전체 소스코드
          - ⚡ **실행 환경**: GitHub Actions
          
          ### 🔗 추가 정보
          - 🛡️ **보안 이슈**: Security 탭에서 확인
          - 📈 **보안 트렌드**: Insights > Security에서 확인
          - 🔧 **수정 가이드**: 각 이슈별 상세 설명 제공
          
          > 💡 **참고**: 보안 이슈가 발견된 경우 Security 탭에서 우선순위와 수정 방법을 확인할 수 있습니다.
          
          ---
          _🤖 CodeQL Advanced Scan | ${new Date().toISOString()}_`;

          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
